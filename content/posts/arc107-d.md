---
title: "ARC107 D Number of Multisets"
date: 2020-11-01T13:40:09+09:00
draft: false
---

解説と違う方法で解いたので書く。

# 要約

1. この問題の答えは次を全て満たす有限数列の個数に等しい。

   - 正整数列である。
   - 数列を $a$ とすると、任意の $i$ について$a_i \leq 2a_{i+1}$である。
   - 数列の総和は$n-k$に等しい。
   - この数列の末項$a_{last}$が存在するとき(数列が空でないとき)、$a_{last}\leq k$である。

2. 上記の数列の個数は `dp[i][j]=(上記の数列の、数列の総和が i, 末項が j 版の個数)`と定義することで計算できる。

3. 累積和による高速化を行うことでこの DP を$O(n^2)$で計算できる。

# くわしく

## 操作への言い換え

条件を満たす多重集合を操作に言い換えて、操作の個数を計算したい。条件を満たす集合は以下のような操作で作られていると考えることができる。

1. $1$ が $k$ 個あるような多重集合 $M$ を用意する。
2. 以下を $n-k$ 回行う。

   - $M$の元$x$を一つ選んで削除し、$M$に$x/2$を 2 つ挿入する。(以下分割すると呼ぶ。)

2 つの操作について、分割する順番が異なっていても各指数について同じ回数の分割を行っていれば(各$i$について、$\frac{1}{2^i}$を$\frac{1}{2^{i+1}}$2 つに分割する回数が同じであれば)同じ多重集合になる。よって各指数での分割回数が等しい操作を同じものだと思えば、多重集合に対してただ一つの操作が対応することになる。

## 数列への言い換え 1

上で多重集合を各指数ごとの分割回数に言い換えた。これは数列に変換することができる。多重集合$M$に対して次で定義される無限数列$a$を対応させる。

$$
a_i:=(1/2^i\text{に分割を行う回数})
$$

この数列は次の性質を満たすことがわかる。

1. 非負整数列である。
1. 総和は$n-k$である。
1. 各 i について、$2a_i \geq a_{i+1}$
1. $a_0 \leq k$(1 は k 個しかない)

逆に上を全て満たす数列は全て操作に対応し、すなわち多重集合に対応することもわかる。ゆえに上記を満たす数列を数え上げれば問題に答えられたことになる。

## 数列への言い換え 2

あとはこの数列を dp で数え上げればいいのだが、このままだと dp で少なくとも総和、先頭、最後尾を覚える必要があり地球が爆発してしまう。よって次のような変換を考える。

- 数列の 0 が続く部分を切り落とし、残った部分を反転させる。

ひっくり返した数列は以下を満たすはずである。

- 正整数列である(0 の部分は切り落としたため)。
- 数列を $a$ とすると、任意の $i$ について$a_i \leq 2a_{i+1}$である。
- 数列の総和は$n-k$に等しい。
- この数列の末項$a_{last}$が存在するとき(数列が空でないとき)、$a_{last}\leq k$である。

上を満たす数列が多重集合に対応することはすぐわかる。またこの条件であれば数列の総和と最後尾に関する DP に帰着できそうである。

## DP

有限数列に関して条件 c(s,l)を以下全てを満たすことと定義する。

- 正整数列である。
- 数列を $a$ とすると、任意の $i$ について$a_i \leq 2a_{i+1}$である。
- 数列の総和は$s$に等しい。
- この数列の末項$a_{last}$が存在するとき(数列が空でないとき)、$a_{last}=l$である。

`dp[i][j]=(c(i,j)を満たす数列の総数)`と定義して dp をする。`dp[i][j]`を計算することを考える。和が $i$,最後尾が $j$ なので最後尾を除いた数列は和が $i-j$ である。また $c(i,j)$の 2 の条件から $j$ の前は $1$から$2j$ であればよい。よって以下の遷移が成り立つ。

$$
dp[i][j]=\sum_{p=1}^{2j}dp[i-j][p]
$$

これは累積和による高速化で$O(1)$で計算できる。DP 全体での計算量は$O(n^2)$であり、これは十分間に合う。

<a href="https://atcoder.jp/contests/arc107/submissions/17775537" target="_blank">ソースコード</a>
